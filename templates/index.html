<!DOCTYPE html>
<html>
<head>
    <title>æ—…æ¸¸åŠ©æ‰‹æµ‹è¯•é¡µ</title>
    <!-- æ·»åŠ åŒæ­¥åœ°å›¾åŠ è½½ -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=ed00597451d3480df1514173ff3a671b&callback=initMap"></script>
    <style>
        body { max-width: 800px; margin: 20px auto; padding: 20px; }
        .container { display: flex; gap: 20px; }
        .input-section { flex: 1; }
        #response { 
            white-space: pre-wrap;
            border: 1px solid #ccc;
            padding: 10px;
            min-height: 200px;
        }
        #mapContainer {
            flex: 1;
            height: 400px;
            border: 1px solid #ccc;
        }
        /* å°†æ ·å¼ç§»åˆ°headçš„styleæ ‡ç­¾å†… */
        .loading { color: #666; font-style: italic; }
        .error { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="input-section">
            <h2>æ—…æ¸¸é—®ç­”æµ‹è¯•</h2>
            <textarea id="question" rows="5" style="width: 100%" 
                placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šçƒŸå°æœ‰å“ªäº›é€‚åˆæƒ…ä¾£çš„æ™¯ç‚¹ï¼Ÿ"></textarea>
            <button onclick="submitQuestion()">æäº¤é—®é¢˜</button>
            <h3>å“åº”ç»“æœï¼š</h3>
            <div id="response"></div>
        </div>
        
        <div>
            <h3>åœ°å›¾å±•ç¤ºï¼š</h3>
            <div id="mapContainer"></div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–åœ°å›¾æ ‡è®°æ•°ç»„
        let markers = [];

        // åˆå§‹åŒ–åœ°å›¾ï¼ˆéœ€è¦æ›¿æ¢ä¸ºæ‚¨çš„é«˜å¾·API keyï¼‰
        function initMap() {
            const map = new AMap.Map('mapContainer', {
                zoom: 12,
                center: [121.3914, 37.5393] // çƒŸå°ä¸­å¿ƒåæ ‡
            });
            window.map = map;
        }

        // æäº¤é—®é¢˜åˆ°åç«¯
        async function submitQuestion() {
            const question = document.getElementById('question').value;
            const responseDiv = document.getElementById('response');
            
            try {
                responseDiv.innerHTML = '<div class="loading">æ€è€ƒä¸­...</div>';
                const response = await fetch('http://localhost:8000/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt: question })
                });

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${response.status}`);
                }
                
                const data = await response.json();
                if (!data.answer) {
                    throw new Error('æœåŠ¡å™¨è¿”å›ç©ºå“åº”');
                }
                
                responseDiv.innerHTML = formatResponse(data.answer);
                updateMapMarkers(data.answer);  // ç¡®ä¿æ­¤å‡½æ•°å·²æ­£ç¡®å®šä¹‰
            } catch (error) {
                responseDiv.innerHTML = `<div class="error">è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ ¼å¼åŒ–å“åº”å†…å®¹
        function formatResponse(text) {
            return text.replace(/ğŸ” åœ°å›¾è·³è½¬ï¼š(.*?)( |$)/g, '<a href="$1" target="_blank">[æŸ¥çœ‹åœ°å›¾]</a> ');
        }

        function updateMapMarkers(answer) {
            // æ¸…é™¤æ—§æ ‡è®°
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            // ä»å›ç­”ä¸­æå–æ‰€æœ‰åœ°å›¾é“¾æ¥
            const mapLinks = answer.match(/ğŸ” åœ°å›¾è·³è½¬ï¼š(https:\/\/uri\.amap\.com\/search\?.*?)( |$)/g) || [];
            
            mapLinks.forEach(link => {
                const url = link.split(' ')[0].replace('ğŸ” åœ°å›¾è·³è½¬ï¼š', '');
                const params = new URLSearchParams(url.split('?')[1]);
                const keywords = params.get('keywords');
                const city = params.get('city');
                
                // è°ƒç”¨é«˜å¾·åœ°ç†ç¼–ç API
                AMap.plugin('AMap.Geocoder', () => {
                    const geocoder = new AMap.Geocoder({
                        city: city
                    });
                    
                    geocoder.getLocation(keywords, (status, result) => {
                        if (status === 'complete' && result.geocodes.length > 0) {
                            const location = result.geocodes[0].location;
                            const marker = new AMap.Marker({
                                position: [location.lng, location.lat],
                                map: window.map
                            });
                            markers.push(marker);
                            window.map.setCenter([location.lng, location.lat]);
                        }
                    });
                });
            });
        }

        // åˆå§‹åŒ–åŠ è½½åœ°å›¾
        // ç§»é™¤æ—§çš„window.onloadåˆå§‹åŒ–
        window.onload = function() {
            // ä¿ç•™å…¶ä»–åˆå§‹åŒ–é€»è¾‘ï¼ˆå¦‚æœæœ‰ï¼‰
            initMap(); // ç¡®ä¿åœ°å›¾å·²ç»åŠ è½½
        };
    </script>
</body>
</html>